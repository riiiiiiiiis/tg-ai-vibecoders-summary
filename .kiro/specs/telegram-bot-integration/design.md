# Design Document

## Overview

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram Bot API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∞–º–º–∞—Ä–∏ –≤ —á–∞—Ç—ã. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `SummaryGenerator` —Å –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram" –∏ –Ω–æ–≤—ã–º API endpoint –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏.

## Architecture

### High-Level Flow
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º–º–∞—Ä–∏ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram"
3. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è POST –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–æ–≤—ã–π API endpoint
4. API endpoint —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–∞–º–º–∞—Ä–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Telegram Bot API
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

### Integration Points
- **Frontend**: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `SummaryGenerator` (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞)
- **Backend**: –ù–æ–≤—ã–π API route `/api/send-to-telegram`
- **External**: Telegram Bot API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Configuration**: –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Telegram –±–æ—Ç–∞

## Components and Interfaces

### 1. Frontend Component Updates

**MultiStyleSummaryGenerator Component** (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
- –°–æ—Å—Ç–æ—è–Ω–∏—è: `isSending`, `sendSuccess`, `sendError` –¥–ª—è –∫–∞–∂–¥–æ–π –ø–µ—Ä—Å–æ–Ω—ã
- –§—É–Ω–∫—Ü–∏—è `sendToTelegram(persona, reportData)` –¥–ª—è –≤—ã–∑–æ–≤–∞ API
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö 6 —Ç–∏–ø–æ–≤ –ø–µ—Ä—Å–æ–Ω (curator, twitter, reddit, business, psychologist, creative)

**SummaryGenerator Component** (legacy, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö):
- –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –¢–∞–∫–∂–µ –∏–º–µ–µ—Ç –∫–Ω–æ–ø–∫—É "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram"

### 2. New API Endpoint

**Route**: `POST /api/send-to-telegram`

**Query Parameters**:
- `chat_id` (optional): ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
- `date` (optional): –î–∞—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–º–º–∞—Ä–∏
- `days` (optional): –ü–µ—Ä–∏–æ–¥ (1 –∏–ª–∏ 7 –¥–Ω–µ–π)

**Response Format**:
```typescript
{
  ok: boolean;
  message?: string;
  error?: string;
}
```

### 3. Telegram Service Module

**File**: `lib/telegram.ts`

**Functions**:
- `sendMessageToChat(chatId: string, message: string): Promise<boolean>`
- `formatSummaryForTelegram(report: ReportPayload): string`
- `validateTelegramConfig(): boolean`

**Types**:
```typescript
type TelegramMessage = {
  chat_id: string;
  text: string;
  parse_mode: 'Markdown' | 'HTML';
};

type TelegramResponse = {
  ok: boolean;
  result?: any;
  error_code?: number;
  description?: string;
};
```

### 4. Environment Configuration

**New Variables**:
- `TELEGRAM_BOT_TOKEN` (required): –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç BotFather
- `TELEGRAM_CHAT_ID` (required): ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- `TELEGRAM_THREAD_ID` (optional): ID —Ç—Ä–µ–¥–∞ —Ñ–æ—Ä—É–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–µ–º—É
- `TELEGRAM_API_URL` (optional): URL Telegram API (default: https://api.telegram.org)

## Data Models

### Message Formatting Structure

–°–∞–º–º–∞—Ä–∏ –±—É–¥–µ—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ Telegram Markdown —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```
ü§ñ *AI –î–∞–π–¥–∂–µ—Å—Ç –∑–∞ [–¥–∞—Ç–∞]*

üìä *–°–≤–æ–¥–∫–∞*
[summary text]

üéØ *–¢–µ–º—ã –¥–Ω—è*
‚Ä¢ [theme 1]
‚Ä¢ [theme 2]
‚Ä¢ [theme 3]

üí° *–ò–Ω—Å–∞–π—Ç—ã*
‚Ä¢ [insight 1]
‚Ä¢ [insight 2]
‚Ä¢ [insight 3]

---
_–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–º_
```

### Message Length Handling

Telegram –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 4096 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã**: –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ < 4000 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
2. **–†–∞–∑–±–∏–≤–∫–∞**: –ï—Å–ª–∏ –±–æ–ª—å—à–µ ‚Üí —Ä–∞–∑–±–∏—Ç—å –Ω–∞ —á–∞—Å—Ç–∏:
   - –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Å–≤–æ–¥–∫–∞
   - –í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: —Ç–µ–º—ã –¥–Ω—è
   - –¢—Ä–µ—Ç—å–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –∏–Ω—Å–∞–π—Ç—ã
3. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞**: –û–±—Ä–µ–∑–∞—Ç—å –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é –¥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

## Error Handling

### Configuration Errors
- **Missing Credentials**: –ï—Å–ª–∏ `TELEGRAM_BOT_TOKEN` –∏–ª–∏ `TELEGRAM_CHAT_ID` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã ‚Üí –≤–æ–∑–≤—Ä–∞—Ç 500 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **Invalid Token**: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **Invalid Thread ID**: –ï—Å–ª–∏ `TELEGRAM_THREAD_ID` —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ ‚Üí Telegram API –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É

### Runtime Errors
- **Network Issues**: Timeout –∏–ª–∏ connection errors ‚Üí –≤–æ–∑–≤—Ä–∞—Ç 503 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- **Bot Not in Chat**: –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—Ç 403 —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –¥–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞
- **Invalid Chat ID**: –ï—Å–ª–∏ chat_id –Ω–µ–≤–µ—Ä–Ω—ã–π ‚Üí –≤–æ–∑–≤—Ä–∞—Ç 400 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ

### User Experience
- **Loading State**: –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é..." –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
- **Success State**: –ó–µ–ª–µ–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –°–∞–º–º–∞—Ä–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!"
- **Error State**: –ö—Ä–∞—Å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏

## Testing Strategy

### Unit Tests (Optional)
- `lib/telegram.ts` —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### Integration Tests (Optional)
- API endpoint `/api/send-to-telegram`
- –ü–æ–ª–Ω—ã–π flow: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞
- Error handling scenarios

### Manual Testing Scenarios
1. **Happy Path**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–º–∞—Ä–∏ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è
2. **Configuration Issues**: –¢–µ—Å—Ç –±–µ–∑ —Ç–æ–∫–µ–Ω–∞, —Å –Ω–µ–≤–µ—Ä–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. **Bot Permissions**: –¢–µ—Å—Ç —Å –±–æ—Ç–æ–º –Ω–µ –≤ —á–∞—Ç–µ, —Å –±–æ—Ç–æ–º –±–µ–∑ –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É
4. **Long Messages**: –¢–µ—Å—Ç —Å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º —Å–∞–º–º–∞—Ä–∏
5. **Network Issues**: –¢–µ—Å—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Telegram API

## Security Considerations

### Token Management
- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –∏–ª–∏ –æ—à–∏–±–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### Input Validation
- –í–∞–ª–∏–¥–∞—Ü–∏—è `chat_id` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º)
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–∞–º–º–∞—Ä–∏ –¥–ª—è Markdown
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limiting) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

### Error Information
- –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –æ—à–∏–±–∫–∞—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É

## Implementation Notes

### Telegram Bot API Integration
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram Bot API: `https://api.telegram.org/bot{token}/sendMessage`
- –ú–µ—Ç–æ–¥: POST
- Content-Type: application/json
- Timeout: 10 —Å–µ–∫—É–Ω–¥

### Message Formatting
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown parse_mode –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown –≤ —Ç–µ–∫—Å—Ç–µ
- –î–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è

### Performance Considerations
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–∞–º–º–∞—Ä–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI
- Retry logic –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ —Å–µ—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## Future Enhancements (Out of Scope)

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∞–º–º–∞—Ä–∏
- –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ UI
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- Webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏